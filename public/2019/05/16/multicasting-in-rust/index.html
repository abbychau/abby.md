<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.0" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="CreationsMusicFlower1LOL rerenderedSecond Run Midi Remix (midi version)Second Run Midi Remix (mp3 version)Saber Wing Cure My SoundCloud Paintings">
<meta name="keywords" content="Programming,abbychau,blog,PHP,Rust">
<meta property="og:type" content="website">
<meta property="og:title" content="creations">
<meta property="og:url" content="https://blog.abby.md/creations/index.html">
<meta property="og:site_name" content="abby::blog">
<meta property="og:description" content="CreationsMusicFlower1LOL rerenderedSecond Run Midi Remix (midi version)Second Run Midi Remix (mp3 version)Saber Wing Cure My SoundCloud Paintings">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-06-14T14:04:54.534Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="creations">
<meta name="twitter:description" content="CreationsMusicFlower1LOL rerenderedSecond Run Midi Remix (midi version)Second Run Midi Remix (mp3 version)Saber Wing Cure My SoundCloud Paintings">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.abby.md/creations/">





  <title>Multicasting in Rust | abby::blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">abby::blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Simply Technical Sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br>
            
            links
          </a>
        </li>
      
        
        <li class="menu-item menu-item-projects">
          <a href="/projects/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-laptop-code"></i> <br>
            
            projects
          </a>
        </li>
      
        
        <li class="menu-item menu-item-creations">
          <a href="/creations/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-paint-brush"></i> <br>
            
            creations
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/05/16/multicasting-in-rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Multicasting in Rust</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-16T15:04:24+09:00">2019-05-16</time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Networking/" itemprop="url" rel="index">
                    <span itemprop="name">Networking</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="What-is-multicasting"><a href="#What-is-multicasting" class="headerlink" title="What is multicasting?"></a>What is multicasting?</h2><p>Multicast is in parallel with concepts <code>unicast</code>, <code>broadcast</code> and <code>anycast</code>.</p>
<ul>
<li><code>unicast</code>: single source to single target (TCP or UDP)</li>
<li><code>broadcast</code>: many sources to many targets on a <strong>single network</strong> (UDP)</li>
<li><code>anycast</code>: single source to <strong>one of many targets</strong> (TCP and UDP)</li>
<li><code>multicast</code>: many source to many target (UDP and RTP)</li>
</ul>
<p>There are many setting details for the first three group communications but now we focus on the last one.</p>
<h2 id="Features-of-multicast"><a href="#Features-of-multicast" class="headerlink" title="Features of multicast"></a>Features of <code>multicast</code></h2><ul>
<li>Multicasting gives the ability for many sources to deliver packets to many destinations. </li>
<li>Similar to broadcasting, but <code>multicast</code> allows for these distributed packets to be delivered to more nodes than just the ones attached to the hosts network. </li>
<li>Multicast attempts to reduce congestion by requiring services that wish to receive multicast packets to “join” a multicast address for interest.</li>
<li><code>joins</code> are then announced to upstream routers, where different network address spaces define the scope or range up the network stack that these memberships should be announced (see rfc5771 and rfc7346 for IPv4 and IPv6 registrations). </li>
<li>This is to help prevent floods of multicast traffic hitting the Internet.</li>
</ul>
<h2 id="When-should-you-use-multicasting"><a href="#When-should-you-use-multicasting" class="headerlink" title="When should you use multicasting?"></a>When should you use multicasting?</h2><p>Whenever you need to deliver the same data to many destinations. Multicast addresses usually look like an obvious range like <code>224.0.0.251</code> (v4) or <code>FACE::FB</code> (v6) .</p>
<h2 id="Multicasting-in-Rust"><a href="#Multicasting-in-Rust" class="headerlink" title="Multicasting in Rust"></a>Multicasting in Rust</h2><ul>
<li>There is a sender and a receiver (like UDP), but the desitination IP address being sent to is a <a href="https://en.wikipedia.org/wiki/Multicast_address" target="_blank" rel="noopener">multicast address</a>.</li>
</ul>
<table>
<thead>
<tr>
<th>D类地址</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>224.0.0.1</td>
<td>在一个子网上的所有主机</td>
</tr>
<tr>
<td>224.0.0.2</td>
<td>在一个子网上的所有路由器</td>
</tr>
<tr>
<td>224.0.0.4</td>
<td>所有DVMRP协议的路由器</td>
</tr>
<tr>
<td>224.0.0.5</td>
<td>所有开放最短路径优先（OSPF）路由器</td>
</tr>
<tr>
<td>224.0.0.6</td>
<td>所有OSPF指定路由器</td>
</tr>
<tr>
<td>224.0.0.9</td>
<td>所有RIPv2路由器</td>
</tr>
<tr>
<td>224.0.0.13</td>
<td>所有PIM协议路由器</td>
</tr>
<tr>
<td>224.0.0.0-224.0.0.255</td>
<td>保留作本地使用，做管理和维护任务</td>
</tr>
<tr>
<td>239.0.0.0-239.255.255.255</td>
<td>留用做管理使用</td>
</tr>
</tbody>
</table>
<h2 id="Coding-Example"><a href="#Coding-Example" class="headerlink" title="Coding Example"></a>Coding Example</h2><p>This example is using the <code>std::net::UdpSocket</code></p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> std::net::Ipv4Addr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> socket = UdpSocket::bind(<span class="string">"0.0.0.0:8888"</span>).unwrap();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> buf = [<span class="number">0u8</span>; <span class="number">65535</span>];</span><br><span class="line">    <span class="keyword">let</span> multi_addr = Ipv4Addr::new(<span class="number">234</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">let</span> inter = Ipv4Addr::new(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    socket.join_multicast_v4(&amp;multi_addr,&amp;inter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (amt, src) = socket.recv_from(&amp;<span class="keyword">mut</span> buf).unwrap();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"received &#123;&#125; bytes from &#123;:?&#125;"</span>, amt, src);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> socket = UdpSocket::bind(<span class="string">"0.0.0.0:9999"</span>).unwrap();</span><br><span class="line">    <span class="keyword">let</span> buf = [<span class="number">1u8</span>; <span class="number">15000</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> count = <span class="number">1473</span>;</span><br><span class="line">    socket.send_to(&amp;buf[<span class="number">0</span>..count], <span class="string">"234.2.2.2:8888"</span>).unwrap();</span><br><span class="line"></span><br><span class="line">    thread::sleep_ms(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h2><p><code>std::net::UdpSocket</code> is actually not providing all options from <code>libc</code>. <code>socket2</code> provide them.</p>
<p>Let’s have a look on <a href="https://github.com/bluejekyll/multicast-example/blob/master/src/lib.rs" target="_blank" rel="noopener">this example</a>.</p>
<p>We will use these : <code>use socket2::{Domain, Protocol, SockAddr, Socket, Type};</code>.</p>
<h4 id="Step-1-Bind"><a href="#Step-1-Bind" class="headerlink" title="Step 1: Bind"></a>Step 1: Bind</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(unix)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">bind_multicast</span></span>(socket: &amp;Socket, addr: &amp;SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    socket.bind(&amp;socket2::SockAddr::from(*addr))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The binding method is different from Windows and *nix, that, in Windows, </p>
<p><a href="https://docs.microsoft.com/zh-tw/windows/desktop/api/winsock/nf-winsock-bind" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/desktop/api/winsock/nf-winsock-bind</a> mentions:</p>
<blockquote>
<p>For multicast operations, the preferred method is to call the bind function to associate a socket with a local IP address and then join the multicast group. Although this order of operations is not mandatory, it is strongly recommended. So a multicast application would first select an IPv4 or IPv6 address on the local computer, the wildcard IPv4 address (INADDR_ANY), or the wildcard IPv6 address (in6addr_any). The the multicast application would then call the bind function with this address in the in the sa_data member of the name parameter to associate the local IP address with the socket. If a wildcard address was specified, then Windows will select the local IP address to use. After the bind function completes, an application would then join the multicast group of interest. For more information on how to join a multicast group, see the section on Multicast Programming. This socket can then be used to receive multicast packets from the multicast group using the recv, recvfrom, WSARecv, WSARecvEx, WSARecvFrom, or WSARecvMsg functions.</p>
</blockquote>
<p>In short, we need a <code>INADDR_ANY</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(windows)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">bind_multicast</span></span>(socket: &amp;Socket, addr: &amp;SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> addr = <span class="keyword">match</span> *addr &#123;</span><br><span class="line">        SocketAddr::V4(addr) =&gt; SocketAddr::new(Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(), addr.port()),</span><br><span class="line">        SocketAddr::V6(addr) =&gt; &#123;</span><br><span class="line">            SocketAddr::new(Ipv6Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(), addr.port())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    socket.bind(&amp;socket2::SockAddr::from(addr))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-2-Join"><a href="#Step-2-Join" class="headerlink" title="Step 2: Join"></a>Step 2: Join</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">join_multicast</span></span>(addr: SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;UdpSocket&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> ip_addr = addr.ip();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> socket = new_socket(&amp;addr)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// depending on the IP protocol we have slightly different work</span></span><br><span class="line">    <span class="keyword">match</span> ip_addr &#123;</span><br><span class="line">        IpAddr::V4(<span class="keyword">ref</span> mdns_v4) =&gt; &#123;</span><br><span class="line">            <span class="comment">// join to the multicast address, with all interfaces</span></span><br><span class="line">            socket.join_multicast_v4(mdns_v4, &amp;Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))?;</span><br><span class="line">        &#125;</span><br><span class="line">        IpAddr::V6(<span class="keyword">ref</span> mdns_v6) =&gt; &#123;</span><br><span class="line">            <span class="comment">// join to the multicast address, with all interfaces (ipv6 uses indexes not addresses)</span></span><br><span class="line">            socket.join_multicast_v6(mdns_v6, <span class="number">0</span>)?;</span><br><span class="line">            socket.set_only_v6(<span class="literal">true</span>)?;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bind us to the socket address.</span></span><br><span class="line">    bind_multicast(&amp;socket, &amp;addr)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to standard sockets</span></span><br><span class="line">    <span class="literal">Ok</span>(socket.into_udp_socket())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-3-Listener-and-Sender"><a href="#Step-3-Listener-and-Sender" class="headerlink" title="Step 3: Listener and Sender"></a>Step 3: Listener and Sender</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">multicast_listener</span></span>(</span><br><span class="line">    response: &amp;<span class="symbol">'static</span> <span class="built_in">str</span>,</span><br><span class="line">    client_done: Arc&lt;AtomicBool&gt;,</span><br><span class="line">    addr: SocketAddr,</span><br><span class="line">) -&gt; JoinHandle&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// A barrier to not start the client test code until after the server is running</span></span><br><span class="line">    <span class="keyword">let</span> server_barrier = Arc::new(Barrier::new(<span class="number">2</span>));</span><br><span class="line">    <span class="keyword">let</span> client_barrier = Arc::clone(&amp;server_barrier);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> join_handle = std::thread::Builder::new()</span><br><span class="line">        .name(<span class="built_in">format!</span>(<span class="string">"&#123;&#125;:server"</span>, response))</span><br><span class="line">        .spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="comment">// socket creation will go here...</span></span><br><span class="line">            <span class="keyword">let</span> listener = join_multicast(addr).expect(<span class="string">"failed to create listener"</span>);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: joined: &#123;&#125;"</span>, response, addr);</span><br><span class="line"></span><br><span class="line">            server_barrier.wait();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: is ready"</span>, response);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We'll be looping until the client indicates it is done.</span></span><br><span class="line">            <span class="keyword">while</span> !client_done.load(std::sync::atomic::Ordering::Relaxed) &#123;</span><br><span class="line">                <span class="comment">// test receive and response code will go here...</span></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> buf = [<span class="number">0u8</span>; <span class="number">64</span>]; <span class="comment">// receive buffer</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// we're assuming failures were timeouts, the client_done loop will stop us</span></span><br><span class="line">                <span class="keyword">match</span> listener.recv_from(&amp;<span class="keyword">mut</span> buf) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>((len, remote_addr)) =&gt; &#123;</span><br><span class="line">                        <span class="keyword">let</span> data = &amp;buf[..len];</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">println!</span>(</span><br><span class="line">                            <span class="string">"&#123;&#125;:server: got data: &#123;&#125; from: &#123;&#125;"</span>,</span><br><span class="line">                            response,</span><br><span class="line">                            <span class="built_in">String</span>::from_utf8_lossy(data),</span><br><span class="line">                            remote_addr</span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// create a socket to send the response</span></span><br><span class="line">                        <span class="keyword">let</span> responder = new_socket(&amp;remote_addr)</span><br><span class="line">                            .expect(<span class="string">"failed to create responder"</span>)</span><br><span class="line">                            .into_udp_socket();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// we send the response that was set at the method beginning</span></span><br><span class="line">                        responder</span><br><span class="line">                            .send_to(response.as_bytes(), &amp;remote_addr)</span><br><span class="line">                            .expect(<span class="string">"failed to respond"</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: sent response to: &#123;&#125;"</span>, response, remote_addr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Err</span>(err) =&gt; &#123;</span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: got an error: &#123;&#125;"</span>, response, err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: client is done"</span>, response);</span><br><span class="line">        &#125;)</span><br><span class="line">        .unwrap();</span><br><span class="line"></span><br><span class="line">    client_barrier.wait();</span><br><span class="line">    join_handle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">new_sender</span></span>(addr: &amp;SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;UdpSocket&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> socket = new_socket(addr)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> addr.is_ipv4() &#123;</span><br><span class="line">        socket.set_multicast_if_v4(&amp;Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))?;</span><br><span class="line"></span><br><span class="line">        socket.bind(&amp;SockAddr::from(SocketAddr::new(</span><br><span class="line">            Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">        )))?;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *WARNING* THIS IS SPECIFIC TO THE AUTHORS COMPUTER</span></span><br><span class="line">        <span class="comment">//   find the index of your IPv6 interface you'd like to test with.</span></span><br><span class="line">        socket.set_multicast_if_v6(<span class="number">5</span>)?;</span><br><span class="line"></span><br><span class="line">        socket.bind(&amp;SockAddr::from(SocketAddr::new(</span><br><span class="line">            Ipv6Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">        )))?;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to standard sockets...</span></span><br><span class="line">    <span class="literal">Ok</span>(socket.into_udp_socket())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-4-Using-Listener-and-Sender"><a href="#Step-4-Using-Listener-and-Sender" class="headerlink" title="Step 4: Using Listener and Sender"></a>Step 4: Using Listener and Sender</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">test_multicast</span></span>(test: &amp;<span class="symbol">'static</span> <span class="built_in">str</span>, addr: IpAddr) &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(addr.is_multicast());</span><br><span class="line">    <span class="keyword">let</span> addr = SocketAddr::new(addr, PORT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> client_done = Arc::new(AtomicBool::new(<span class="literal">false</span>));</span><br><span class="line">    <span class="keyword">let</span> notify = NotifyServer(Arc::clone(&amp;client_done));</span><br><span class="line"></span><br><span class="line">    multicast_listener(test, client_done, addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client test code send and receive code after here</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:client: running"</span>, test);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">b"Hello from client!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the sending socket</span></span><br><span class="line">    <span class="keyword">let</span> socket = new_sender(&amp;addr).expect(<span class="string">"could not create sender!"</span>);</span><br><span class="line">    socket.send_to(message, &amp;addr).expect(<span class="string">"could not send_to!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> buf = [<span class="number">0u8</span>; <span class="number">64</span>]; <span class="comment">// receive buffer</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> socket.recv_from(&amp;<span class="keyword">mut</span> buf) &#123;</span><br><span class="line">        <span class="literal">Ok</span>((len, remote_addr)) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> data = &amp;buf[..len];</span><br><span class="line">            <span class="keyword">let</span> response = <span class="built_in">String</span>::from_utf8_lossy(data);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:client: got data: &#123;&#125;"</span>, test, response);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// verify it's what we expected</span></span><br><span class="line">            <span class="built_in">assert_eq!</span>(test, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Err</span>(err) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:client: had a problem: &#123;&#125;"</span>, test, err);</span><br><span class="line">            <span class="built_in">assert!</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure we don't notify the server until the end of the client test</span></span><br><span class="line">    <span class="built_in">drop</span>(notify);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Comparing to C++ clients and servers. std libraries in Rust is much simpler, but to write codes with greater control, Rust is quite verbose but still very readable in comparison.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Rust/" rel="tag"># Rust,</a>
          
            <a href="/tags/ipv4/" rel="tag"># ipv4,</a>
          
            <a href="/tags/ipv6/" rel="tag"># ipv6,</a>
          
            <a href="/tags/multicast/" rel="tag"># multicast</a>
          
            <a href="/tags/udp/" rel="tag"># udp</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/17/How-does-nom-work/" rel="prev" title="How does nom v.5 work?">
                How does nom v.5 work? <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec" alt="Abby Chau">
            
              <p class="site-author-name" itemprop="name">Abby Chau</p>
              <p class="site-description motion-element" itemprop="description">Sharing different computer parts</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/abbychau" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://soundcloud.com/abbychau" target="_blank" title="SoundCloud">
                      
                        <i class="fa fa-fw fa-soundcloud"></i>SoundCloud</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/abbychau" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/zkizabby" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/abbychau" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/abbychau2000" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/abbychau" target="_blank" title="ZhiHu">
                      
                        <i class="fa fa-fw fa-zhihu"></i>ZhiHu</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-multicasting"><span class="nav-number">1.</span> <span class="nav-text">What is multicasting?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Features-of-multicast"><span class="nav-number">2.</span> <span class="nav-text">Features of multicast</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#When-should-you-use-multicasting"><span class="nav-number">3.</span> <span class="nav-text">When should you use multicasting?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Multicasting-in-Rust"><span class="nav-number">4.</span> <span class="nav-text">Multicasting in Rust</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Coding-Example"><span class="nav-number">5.</span> <span class="nav-text">Coding Example</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Server"><span class="nav-number">5.0.1.</span> <span class="nav-text">Server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Client"><span class="nav-number">5.0.2.</span> <span class="nav-text">Client</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#Example-2"><span class="nav-number">6.</span> <span class="nav-text">Example 2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-1-Bind"><span class="nav-number">6.0.1.</span> <span class="nav-text">Step 1: Bind</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-2-Join"><span class="nav-number">6.0.2.</span> <span class="nav-text">Step 2: Join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-3-Listener-and-Sender"><span class="nav-number">6.0.3.</span> <span class="nav-text">Step 3: Listener and Sender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-4-Using-Listener-and-Sender"><span class="nav-number">6.0.4.</span> <span class="nav-text">Step 4: Using Listener and Sender</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Conclusion"><span class="nav-number">7.</span> <span class="nav-text">Conclusion</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Abby Chau</span>

  

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.0.0</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.0"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
