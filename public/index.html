<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.0" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Sharing different computer parts">
<meta name="keywords" content="Programming,abbychau,blog,PHP,Rust">
<meta property="og:type" content="website">
<meta property="og:title" content="All Categories">
<meta property="og:url" content="https://blog.abby.md/categories/index.html">
<meta property="og:site_name" content="abby::blog">
<meta property="og:description" content="Sharing different computer parts">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-05-19T23:58:12.319Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="All Categories">
<meta name="twitter:description" content="Sharing different computer parts">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.abby.md/categories/">





  <title>abby::blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">abby::blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Simply Technical Sharing</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br>
            
            links
          </a>
        </li>
      
        
        <li class="menu-item menu-item-projects">
          <a href="/projects/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cube"></i> <br>
            
            projects
          </a>
        </li>
      
        
        <li class="menu-item menu-item-creations">
          <a href="/creations/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-paint-brush"></i> <br>
            
            creations
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/06/06/multiqueue2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/06/multiqueue2/" itemprop="url">The things I tested on a broadcast queue - multiqueue2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-06T18:02:21+09:00">2019-06-06</time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>MultiQueue2 is a fast bounded mpmc queue that supports broadcast/broadcast style operations</p>
<p>MultiQueue was developed by Sam Schetterer, but not updated for some time. I found it very useful as it implements futures. However, it is with a few outdated library API and the use of spin locks is taking 100% CPU in many cases.</p>
<h1 id="Stone-Age"><a href="#Stone-Age" class="headerlink" title="Stone Age"></a>Stone Age</h1><p>For any channels, if there is a potential for conflicts (more than one of the writers/readers are consuming the resources), there must be locks. So the 100% issue is very likely to be caused by a spinlock.</p>
<p>At first, I did it in the <code>sleep way</code></p>
<figure class="highlight rs"><figcaption><span>wait.rs</span><a href="https://github.com/abbychau/multiqueue2/blob/a850ed674ccb7c2d47fddcbe72070cca0efa6cc2/src/wait.rs" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">check</span></span>(seq: <span class="built_in">usize</span>, at: &amp;AtomicUsize, wc: &amp;AtomicUsize) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cur_count = load_tagless(at);</span><br><span class="line">    <span class="keyword">use</span> std::&#123;thread, time&#125;;</span><br><span class="line">    thread::sleep(time::Duration::from_millis(<span class="number">50</span>));</span><br><span class="line">    wc.load(Relaxed) == <span class="number">0</span> || seq == cur_count || past(seq, cur_count).<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nonetheless, I sacrified the throughput because I punished every check.</p>
<p>And then, I tried a much <a href="https://github.com/abbychau/multiqueue2/commit/67ff0f3dc8e33467125a7fe6b5a57b25747678eb" target="_blank" rel="noopener">smaller sleep</a>. This is just meaningless because it does not trigger CPU from P-State to S-State. And I immediately find that it may be fool to cocerce S-State in a spinlock design.</p>
<p>And then I tried 1ms,10ms,1000ns, for both settings of <code>check after wait</code> or <code>check before wait</code>. <a href="https://github.com/abbychau/multiqueue2/commit/d3c9403762a34bbe11642419f66658844ec4d75d" target="_blank" rel="noopener">link</a>. It does not make much different.</p>
<p>I tried the <code>_mm_pause</code> from <code>SSE2</code> as well, but it does not make any different. </p>
<figure class="highlight rs"><figcaption><span>wait.rs</span><a href="https://github.com/abbychau/multiqueue2/blob/d82603a08a4d4e0875054e7dd9ac0a63dee928d5/src/wait.rs" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">check</span></span>(seq: <span class="built_in">usize</span>, at: &amp;AtomicUsize, wc: &amp;AtomicUsize) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cur_count = load_tagless(at);</span><br><span class="line">    <span class="keyword">if</span> is_x86_feature_detected!(<span class="string">"sse2"</span>) &#123;</span><br><span class="line">        <span class="meta">#[cfg(target_arch = <span class="meta-string">"x86"</span>)]</span></span><br><span class="line">        <span class="keyword">use</span> std::arch::x86::_mm_pause;</span><br><span class="line">        <span class="meta">#[cfg(target_arch = <span class="meta-string">"x86_64"</span>)]</span></span><br><span class="line">        <span class="keyword">use</span> std::arch::x86_64::_mm_pause;</span><br><span class="line">        <span class="keyword">unsafe</span>&#123;</span><br><span class="line">            _mm_pause();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">use</span> std::&#123;thread, time&#125;;</span><br><span class="line">        thread::sleep(time::Duration::from_millis(DEFAULT_CHECK_DELAY));</span><br><span class="line">    &#125;</span><br><span class="line">    wc.load(Relaxed) == <span class="number">0</span> || seq == cur_count || past(seq, cur_count).<span class="number">1</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Although <code>_mm_pause</code> is designed for spinlock, but the point is CPU will not switch P-State and S-State just for a few nono-seconds. It is simply not the right way.</p>
<h1 id="Tool-Age"><a href="#Tool-Age" class="headerlink" title="Tool Age"></a>Tool Age</h1><p>Keep trying the trival ways will never proceed more (although it practically solved the system problem of 100% cpu usage in my program and my program is not required to be very performant too), so I stepped back and rethought about my first solution.</p>
<p>The first solution was actually doing less checking and forcing the cpu to sleep, so that it does not waste too much energy to do useless checkings which are 99%(roughly) predictable.</p>
<p>What I really want to punish are the collided conflicts, because they are very likely to be blocked again if the CPU checks in the next cycle. At this time, sleeping is better than checking.</p>
<p>So I make the spinlock to be a swing-back one.</p>
<figure class="highlight rs"><figcaption><span>wait.rs</span><a href="https://github.com/abbychau/multiqueue2/blob/74dd8254c6c6f8f4148ef2be9d4f8ed9d89e124d/src/wait.rs" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[inline(always)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">check</span></span>(seq: <span class="built_in">usize</span>, at: &amp;AtomicUsize, wc: &amp;AtomicUsize) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> cur_count = load_tagless(at);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> wc.load(Relaxed) == <span class="number">0</span> || seq == cur_count || past(seq, cur_count).<span class="number">1</span> &#123;</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">use</span> std::&#123;thread, time&#125;;</span><br><span class="line">        thread::sleep(time::Duration::from_millis(DEFAULT_CHECK_DELAY));</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This works exactly as expected. The cpu usage lowered and the through-put is able to pass all the tests.</p>
<h1 id="Futures"><a href="#Futures" class="headerlink" title="Futures"></a>Futures</h1><p>However, I then found that the CPU usage is high for future queues. That, there is a kind of hybrid lock used for future queues. </p>
<p>Therefore, I removed all the Spin before going to <code>parking_lot::Mutex::new(VecDeque::new())</code>. <a href="https://github.com/abbychau/multiqueue2/commit/f311c7c02c392a656df85d662f8b3c1048536457" target="_blank" rel="noopener">link</a></p>
<p>It increases the number of low level context switches very much but indeed lowed the CPU usage. By the nature of this heavy switch comparing to the light weight spinlock, the through-put of future queues becomes just 1/10 of the normal queue.</p>
<p>And this experiment also taught me the performance ratio between <code>parking_lot</code> mutexes and native spins.</p>
<h1 id="No-Silver-Bullet"><a href="#No-Silver-Bullet" class="headerlink" title="No Silver Bullet"></a>No Silver Bullet</h1><p>I really would like to come up with an equation for people to set the <code>try_spins</code> precisely, but it is very complicated because it includes all the envirnment information like CPU frequency, number of consumers, rate of feeding, etc.</p>
<p>So I can just left it to the user.</p>
<figure class="highlight rs"><figcaption><span>multiqueue.rs</span><a href="https://github.com/abbychau/multiqueue2/blob/master/src/multiqueue.rs" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Usage: futures_multiqueue_with(`capacity`,`try_spins`,`yield_spins`)</span></span><br><span class="line"><span class="comment">/// `capacity` is the maximum item to be allowed in queue; when it is full, `Err(Full&#123;...&#125;)` will be emitted</span></span><br><span class="line"><span class="comment">/// `try_spins` is a performant, low latency blocking wait for lightweight conflict solving, lower this number when your CPU usage is high.</span></span><br><span class="line"><span class="comment">/// `yield_spins` is still busy but slowered by `yield()`, this number can be small.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// `futures_multiqueue_with(1000,0,0)` is possible, which  will turn this hybrid-lock into a kernal lock.</span></span><br><span class="line"><span class="comment">/// Feel free to test different setting that matches your system.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">futures_multiqueue_with</span></span>&lt;RW: QueueRW&lt;T&gt;, T&gt;(</span><br><span class="line">    capacity: Index,</span><br><span class="line">    try_spins: <span class="built_in">usize</span>,</span><br><span class="line">    yield_spins: <span class="built_in">usize</span>,</span><br><span class="line">) -&gt; (FutInnerSend&lt;RW, T&gt;, FutInnerRecv&lt;RW, T&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> cons_arc = Arc::new(FutWait::with_spins(try_spins, yield_spins));</span><br><span class="line">    <span class="keyword">let</span> prod_arc = Arc::new(FutWait::with_spins(try_spins, yield_spins));</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = MultiQueue::new_internal(capacity, cons_arc.clone());</span><br><span class="line">    <span class="keyword">let</span> ftx = FutInnerSend &#123;</span><br><span class="line">        writer: tx,</span><br><span class="line">        wait: cons_arc.clone(),</span><br><span class="line">        prod_wait: prod_arc.clone(),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> rtx = FutInnerRecv &#123;</span><br><span class="line">        reader: rx,</span><br><span class="line">        wait: cons_arc.clone(),</span><br><span class="line">        prod_wait: prod_arc.clone(),</span><br><span class="line">    &#125;;</span><br><span class="line">    (ftx, rtx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I would like to investigate and develop a clear equation for concurrency hybrid lock, but it seems to be a bit long and I may have it later in a Paper form.</p>
<p>Feel free to leave issues or comments.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/05/24/Mio-Based-Coroutine-Libs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/24/Mio-Based-Coroutine-Libs/" itemprop="url">Mio Based Coroutine Libs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-24T09:01:22+09:00">2019-05-24</time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Candidates"><a href="#Candidates" class="headerlink" title="Candidates"></a>Candidates</h1><ol>
<li><a href="https://github.com/dpc/mioco" target="_blank" rel="noopener">mioco</a></li>
<li><a href="https://github.com/zonyitoo/coio-rs" target="_blank" rel="noopener">coio</a></li>
<li><a href="https://github.com/Xudong-Huang/may" target="_blank" rel="noopener">may</a></li>
<li><a href="https://github.com/tokio-rs/tokio" target="_blank" rel="noopener">tokio</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/05/20/Benchmarking-nom-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/20/Benchmarking-nom-2/" itemprop="url">Benchmarking nom 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-20T10:08:27+09:00">2019-05-20</time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/" itemprop="url" rel="index">
                    <span itemprop="name">Rust</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Prolog"><a href="#Prolog" class="headerlink" title="Prolog"></a>Prolog</h2><p>In the previous post : “Benchmarking nom”. We tried a test without really making use of the real feature that nom provide. I won’t go deep this time either, but let’s make <code>is_hex_digit</code> really working and to ensure that no error will be passed into conversion.</p>
<h2 id="Changes"><a href="#Changes" class="headerlink" title="Changes"></a>Changes</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_hex_digit</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    c.is_digit(<span class="number">16</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The parsing function of <code>direct.rs</code> becomes:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">structure1</span></span>(c: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;Color, &amp;<span class="built_in">str</span>&gt; &#123;</span><br><span class="line">    <span class="built_in">macro_rules!</span> mc1 &#123;</span><br><span class="line">        ($from:expr,$to:expr) =&gt; &#123;&#123;</span><br><span class="line">            <span class="keyword">for</span> ele <span class="keyword">in</span> c[$from..$to].chars() &#123;</span><br><span class="line">                <span class="keyword">if</span> !is_hex_digit(ele) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">Err</span>(<span class="string">"Oh no"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            from_hex(&amp;c[$from..$to]).unwrap()</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Ok</span>(Color &#123;</span><br><span class="line">        red: mc1!(<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">        green: mc1!(<span class="number">3</span>, <span class="number">5</span>),</span><br><span class="line">        blue: mc1!(<span class="number">5</span>, <span class="number">7</span>),</span><br><span class="line">        number1: to_i64(&amp;c[<span class="number">7</span>..<span class="number">7</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number2: to_i64(&amp;c[<span class="number">7</span> + <span class="number">8</span>..<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number3: to_i64(&amp;c[<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span>..<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number4: to_i64(&amp;c[<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span>..<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number5: to_string(&amp;c[<span class="number">7</span> + <span class="number">8</span> * <span class="number">4</span>..<span class="number">7</span> + <span class="number">8</span> * <span class="number">4</span> + <span class="number">100</span>]).unwrap(),</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>After running a <code>cargo +nightly bench</code>, we got:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">running 1 test</span><br><span class="line">test tests_direct::parse_color1 ... bench:         291 ns/iter (+/- 18)</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 1 measured; 0 filtered out</span><br><span class="line"></span><br><span class="line">     Running target/release/deps/nomtest-a643b08a9c32cd49</span><br><span class="line"></span><br><span class="line">running 1 test</span><br><span class="line">test tests_main::parse_color1 ... bench:         725 ns/iter (+/- 163)</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 1 measured; 0 filtered out</span><br></pre></td></tr></table></figure>
<p>I repeated a couple more times and the readings are similar.</p>
<p>The raw reader changes from 263 to 291 and nom changes from 670 to 725. The increment of punishment of validation is happening inside nom as well. I would suppose the power of <strong>Zero Cost Abstraction</strong> is happening at this corner. It is a bit out of my expection.</p>
<p>Parser is good for reusing many meaningful elements of the string(or bit) format. So without nesting the same element inside the context like <code>json</code>, <code>toml</code>, <code>xml</code>, parsing engine does not payout much.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/05/20/benchmarking-nom/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/20/benchmarking-nom/" itemprop="url">Benchmarking nom</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-20T08:50:01+09:00">2019-05-20</time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/" itemprop="url" rel="index">
                    <span itemprop="name">Rust</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p>Let’s take the example of hello world of <code>nom</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert_eq!</span>(hex_color(<span class="string">"#2F14DF"</span>), <span class="literal">Ok</span>((<span class="string">""</span>, Color &#123;</span><br><span class="line">  red: <span class="number">47</span>,</span><br><span class="line">  green: <span class="number">20</span>,</span><br><span class="line">  blue: <span class="number">223</span>,</span><br><span class="line">&#125;)));</span><br></pre></td></tr></table></figure>
<p>RGB Hex code is very similar to low level TCP/UDP messages. That, for instance of <code>#AABBCC</code>, <code>#</code> means “This is a color, the following message length is 6: 0-1 is for R, 2-3:G, 4-5:B`.</p>
<p>That one can make a theoretically O(n) memory model for it by reading bytes by bytes.</p>
<p>We can also expect a worse performance from a parser doing <code>let (input, (red, green, blue)) = tuple((hex_primary, hex_primary, hex_primary))(input)?;</code></p>
<h2 id="Common-Functions"><a href="#Common-Functions" class="headerlink" title="Common Functions"></a>Common Functions</h2><p>To be fair, here are the common functions shared by two parsers.<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tools.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">from_hex</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">u8</span>, std::num::ParseIntError&gt; &#123;</span><br><span class="line">    <span class="built_in">u8</span>::from_str_radix(input, <span class="number">16</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">to_i64</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">i64</span>, std::num::ParseIntError&gt; &#123;</span><br><span class="line">    input.parse::&lt;<span class="built_in">i64</span>&gt;()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_hex_digit</span></span>(_c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">is_num</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">    c.is_digit(<span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">to_string</span></span>(c: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, ()&gt; &#123;</span><br><span class="line">    <span class="literal">Ok</span>(c.to_string().trim().to_string())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>is_hex_digit</code> is for validation of the input byte by <code>take_while_m_n</code>, which is a very common operation by parsers, but we keep it always returning true so the have the baseline first, before we want the power of the lexical engine.</p>
<h1 id="Nom-Parser"><a href="#Nom-Parser" class="headerlink" title="Nom Parser"></a>Nom Parser</h1><p>We got <code>main.rs</code>, which is using <code>nom</code> as below.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(test)]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_use]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> nom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> tools;</span><br><span class="line"><span class="keyword">use</span> tools::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Color</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> red: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> green: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> blue: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> number1: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number2: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number3: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number4: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number5: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">named!(hex_primary&lt;&amp;<span class="built_in">str</span>, <span class="built_in">u8</span>&gt;,</span><br><span class="line">  map_res!(take_while_m_n!(<span class="number">2</span>, <span class="number">2</span>, is_hex_digit), from_hex)</span><br><span class="line">);</span><br><span class="line">named!(four_length_int&lt;&amp;<span class="built_in">str</span>, <span class="built_in">i64</span>&gt;,</span><br><span class="line">  map_res!(take!(<span class="number">8</span>), to_i64)</span><br><span class="line">);</span><br><span class="line">named!(length8_string&lt;&amp;<span class="built_in">str</span>, <span class="built_in">String</span>&gt;,</span><br><span class="line">  map_res!(take!(<span class="number">8</span>), to_string)</span><br><span class="line">);</span><br><span class="line">named!(length100_string&lt;&amp;<span class="built_in">str</span>, <span class="built_in">String</span>&gt;,</span><br><span class="line">  map_res!(take!(<span class="number">100</span>), to_string)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">from_u8</span></span>(c: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">String</span>, ()&gt; &#123;</span><br><span class="line">    <span class="built_in">print!</span>(<span class="string">"&#123;:?&#125;"</span>, c);</span><br><span class="line">    <span class="literal">Ok</span>(c.to_string())</span><br><span class="line">&#125;</span><br><span class="line">named!(structure1&lt;&amp;<span class="built_in">str</span>, Color&gt;,</span><br><span class="line">  do_parse!(</span><br><span class="line">           tag!(<span class="string">"#"</span>)   &gt;&gt;</span><br><span class="line">    red:   hex_primary &gt;&gt;</span><br><span class="line">    green: hex_primary &gt;&gt;</span><br><span class="line">    blue:  hex_primary &gt;&gt;</span><br><span class="line">    number1: four_length_int &gt;&gt;</span><br><span class="line">    number2: four_length_int &gt;&gt;</span><br><span class="line">    number3: four_length_int &gt;&gt;</span><br><span class="line">    number4: four_length_int &gt;&gt;</span><br><span class="line">    number5: length8_string &gt;&gt;</span><br><span class="line">    (</span><br><span class="line">      Color &#123;</span><br><span class="line">        red,</span><br><span class="line">        green,</span><br><span class="line">        blue,</span><br><span class="line">        number1,</span><br><span class="line">        number2,</span><br><span class="line">        number3,</span><br><span class="line">        number4,</span><br><span class="line">        number5</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests_main &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">crate</span> test;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> test::Bencher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[bench]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">parse_color1</span></span>(b: &amp;<span class="keyword">mut</span> Bencher) &#123;</span><br><span class="line">        b.iter(|| structure1(<span class="string">"#2F14DF888888887777777766666666555555551234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="amp-str-Slice-Reader"><a href="#amp-str-Slice-Reader" class="headerlink" title="&amp;str Slice Reader"></a>&amp;str Slice Reader</h1><p>And <code>direct.rs</code>, which is a direct slice access to <code>&amp;str</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(test)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mod</span> tools;</span><br><span class="line"><span class="keyword">use</span> tools::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Color</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> red: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> green: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> blue: <span class="built_in">u8</span>,</span><br><span class="line">    <span class="keyword">pub</span> number1: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number2: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number3: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number4: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> number5: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">structure1</span></span>(c: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;Color, <span class="built_in">String</span>&gt; &#123;</span><br><span class="line">    <span class="literal">Ok</span>(Color &#123;</span><br><span class="line">        red: from_hex(&amp;c[<span class="number">1</span>..<span class="number">3</span>]).unwrap(),</span><br><span class="line">        green: from_hex(&amp;c[<span class="number">3</span>..<span class="number">5</span>]).unwrap(),</span><br><span class="line">        blue: from_hex(&amp;c[<span class="number">5</span>..<span class="number">7</span>]).unwrap(),</span><br><span class="line">        number1: to_i64(&amp;c[<span class="number">7</span>..<span class="number">7</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number2: to_i64(&amp;c[<span class="number">7</span> + <span class="number">8</span>..<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number3: to_i64(&amp;c[<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span>..<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number4: to_i64(&amp;c[<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span>..<span class="number">7</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span> + <span class="number">8</span>]).unwrap(),</span><br><span class="line">        number5: to_string(&amp;c[<span class="number">7</span> + <span class="number">8</span> * <span class="number">4</span>..<span class="number">7</span> + <span class="number">8</span> * <span class="number">4</span> + <span class="number">100</span>]).unwrap(),</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests_direct &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">extern</span> <span class="keyword">crate</span> test;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> test::Bencher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[bench]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">parse_color1</span></span>(b: &amp;<span class="keyword">mut</span> Bencher) &#123;</span><br><span class="line">        b.iter(|| structure1(<span class="string">"#2F14DF888888887777777766666666555555551234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Both of the are zero-copy during parsing.</p>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>After running a <code>cargo +nightly bench</code>, we got:</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">running 1 test</span><br><span class="line">test tests_direct::parse_color1 ... bench:         263 ns/iter (+/- 22)</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 1 measured; 0 filtered out</span><br><span class="line"></span><br><span class="line">     Running target/release/deps/nomtest-cdc895365399f2bf</span><br><span class="line"></span><br><span class="line">running 1 test</span><br><span class="line">test tests_main::parse_color1 ... bench:         670 ns/iter (+/- 76)</span><br><span class="line"></span><br><span class="line">test result: ok. 0 passed; 0 failed; 0 ignored; 1 measured; 0 filtered out</span><br></pre></td></tr></table></figure>
<p>This is quite close to the expection that how <code>nom</code> is punishing on its lexical techniques. (Testing on a Apple MacBook Pro 2018 i7 16GB RAM)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/05/17/How-does-nom-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/How-does-nom-work/" itemprop="url">How does nom v.5 work?</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-17T09:24:58+09:00">2019-05-17</time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/" itemprop="url" rel="index">
                    <span itemprop="name">Rust</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="What-is-nom"><a href="#What-is-nom" class="headerlink" title="What is nom?"></a>What is nom?</h2><p><code>nom</code> is a parser combinators library written in Rust. Its goal is to provide tools to build safe parsers without compromising the speed or memory consumption. To that end, it uses extensively Rust’s strong typing and memory safety to produce fast and correct parsers, and provides functions, macros and traits to abstract most of the error prone plumbing.</p>
<h2 id="Why-this-passage"><a href="#Why-this-passage" class="headerlink" title="Why this passage?"></a>Why this passage?</h2><p><code>nom</code> version 5 is going through a very large change to the lexical syntax to be used. The old way will not work any more. So this passage will tell and explain the new way.</p>
<h2 id="Hello-Color"><a href="#Hello-Color" class="headerlink" title="Hello Color"></a>Hello Color</h2><p>This is a hello world example for parser that we are going to parse Hex color like <code>#2F14DF</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> nom;</span><br><span class="line"><span class="keyword">use</span> nom::&#123;</span><br><span class="line">  IResult,</span><br><span class="line">  bytes::complete::&#123;tag, take_while_m_n&#125;,</span><br><span class="line">  combinator::map_res,</span><br><span class="line">  sequence::tuple</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug,PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Color</span></span> &#123;</span><br><span class="line">  <span class="keyword">pub</span> red:   <span class="built_in">u8</span>,</span><br><span class="line">  <span class="keyword">pub</span> green: <span class="built_in">u8</span>,</span><br><span class="line">  <span class="keyword">pub</span> blue:  <span class="built_in">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">from_hex</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">u8</span>, std::num::ParseIntError&gt; &#123;</span><br><span class="line">  <span class="built_in">u8</span>::from_str_radix(input, <span class="number">16</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">is_hex_digit</span></span>(c: <span class="built_in">char</span>) -&gt; <span class="built_in">bool</span> &#123;</span><br><span class="line">  c.is_digit(<span class="number">16</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hex_primary</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; IResult&lt;&amp;<span class="built_in">str</span>, <span class="built_in">u8</span>&gt; &#123;</span><br><span class="line">  map_res(</span><br><span class="line">    take_while_m_n(<span class="number">2</span>, <span class="number">2</span>, is_hex_digit),</span><br><span class="line">    from_hex</span><br><span class="line">  )(input)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hex_color</span></span>(input: &amp;<span class="built_in">str</span>) -&gt; IResult&lt;&amp;<span class="built_in">str</span>, Color&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> (input, _) = tag(<span class="string">"#"</span>)(input)?;</span><br><span class="line">  <span class="keyword">let</span> (input, (red, green, blue)) = tuple((hex_primary, hex_primary, hex_primary))(input)?;</span><br><span class="line"></span><br><span class="line">  <span class="literal">Ok</span>((input, Color &#123; red, green, blue &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">parse_color</span></span>() &#123;</span><br><span class="line">  <span class="built_in">assert_eq!</span>(hex_color(<span class="string">"#2F14DF"</span>), <span class="literal">Ok</span>((<span class="string">""</span>, Color &#123;</span><br><span class="line">    red: <span class="number">47</span>,</span><br><span class="line">    green: <span class="number">20</span>,</span><br><span class="line">    blue: <span class="number">223</span>,</span><br><span class="line">  &#125;)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The combinator is writting in a very functional way.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> (input, _) = tag(<span class="string">"#"</span>)(input)?;</span><br><span class="line"><span class="keyword">let</span> (input, (red, green, blue)) = tuple((hex_primary, hex_primary, hex_primary))(input)?;</span><br><span class="line"></span><br><span class="line"><span class="literal">Ok</span>((input, Color &#123; red, green, blue &#125;))</span><br></pre></td></tr></table></figure>
<p>That, <code>tag(&quot;#&quot;)</code>, <code>tuple((hex_primary, hex_primary, hex_primary))</code> are functions.</p>
<h2 id="Parse-Json"><a href="#Parse-Json" class="headerlink" title="Parse Json"></a>Parse Json</h2><p>Then we come to the real world. They provided a very efficient Json parser as an example of nom.</p>
<p>Please find the example <a href="https://github.com/Geal/nom/blob/master/examples/json.rs" target="_blank" rel="noopener">here</a>.</p>
<p>Revision, this is the defination or state-machine of Json.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">JsonValue</span></span> &#123;</span><br><span class="line">  Str(<span class="built_in">String</span>),</span><br><span class="line">  Boolean(<span class="built_in">bool</span>),</span><br><span class="line">  Num(<span class="built_in">f64</span>),</span><br><span class="line">  Array(<span class="built_in">Vec</span>&lt;JsonValue&gt;),</span><br><span class="line">  Object(HashMap&lt;<span class="built_in">String</span>, JsonValue&gt;),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The following are lexical elements:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">sp</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, &amp;<span class="symbol">'a</span> <span class="built_in">str</span>, E&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> chars = <span class="string">" \t\r\n"</span>;</span><br><span class="line"></span><br><span class="line">  take_while(<span class="keyword">move</span> |c| chars.contains(c))(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Space should be obvious.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">float</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, <span class="built_in">f64</span>, E&gt; &#123;</span><br><span class="line">  flat_map!(i, recognize_float, parse_to!(<span class="built_in">f64</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nom provided features <code>recognize_float</code> and <code>parse_to</code> to do it automatically.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">parse_str</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, &amp;<span class="symbol">'a</span> <span class="built_in">str</span>, E&gt; &#123;</span><br><span class="line">    escaped!(i, call!(alphanumeric), <span class="string">'\\'</span>, one_of!(<span class="string">"\"n\\"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>call!()</code> is a macro to call a named function as callback. It can also take in argument like below.<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">take_wrapper</span></span>(input: &amp;[<span class="built_in">u8</span>], i: <span class="built_in">u8</span>) -&gt; IResult&lt;&amp;[<span class="built_in">u8</span>], &amp;[<span class="built_in">u8</span>]&gt; &#123; take!(input, i * <span class="number">10</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// will make a parser taking 20 bytes</span></span><br><span class="line">named!(parser, call!(take_wrapper, <span class="number">2</span>));</span><br></pre></td></tr></table></figure></p>
<p>For <code>one_of!()</code>:<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">named!(simple&lt;<span class="built_in">char</span>&gt;, one_of!(&amp;<span class="string">b"abc"</span>[..]));</span><br><span class="line"><span class="built_in">assert_eq!</span>(simple(<span class="string">b"a123"</span>), <span class="literal">Ok</span>((&amp;<span class="string">b"123"</span>[..], <span class="string">'a'</span>)));</span><br><span class="line"></span><br><span class="line">named!(a_or_b&lt;&amp;<span class="built_in">str</span>, <span class="built_in">char</span>&gt;, one_of!(<span class="string">"ab汉"</span>));</span><br><span class="line"><span class="built_in">assert_eq!</span>(a_or_b(<span class="string">"汉jiosfe"</span>), <span class="literal">Ok</span>((<span class="string">"jiosfe"</span>, <span class="string">'汉'</span>)));</span><br></pre></td></tr></table></figure></p>
<p>This following code will extract string lexical elements by <code>{&quot;...&quot;}</code>. We can see that delimiters actually helps programmer to write parsers.<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">string</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, &amp;<span class="symbol">'a</span> <span class="built_in">str</span>, E&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> (i, _) = <span class="built_in">char</span>(<span class="string">'\"'</span>)(i)?;</span><br><span class="line">  context(<span class="string">"string"</span>, terminated(parse_str, <span class="built_in">char</span>(<span class="string">'\"'</span>)))(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Boolean is a simple tag.<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">boolean</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(input: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, <span class="built_in">bool</span>, E&gt; &#123;</span><br><span class="line">  alt( (</span><br><span class="line">      |i| tag(<span class="string">"false"</span>)(i).map(|(i,_)| (i, <span class="literal">false</span>)),</span><br><span class="line">      |i| tag(<span class="string">"true"</span>)(i).map(|(i,_)| (i, <span class="literal">true</span>))</span><br><span class="line">  ))(input)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">array</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, <span class="built_in">Vec</span>&lt;JsonValue&gt;, E&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> (i, _) = <span class="built_in">char</span>(<span class="string">'['</span>)(i)?;</span><br><span class="line"></span><br><span class="line">  context(</span><br><span class="line">    <span class="string">"array"</span>,</span><br><span class="line">    terminated(</span><br><span class="line">      |i| separated_listc(i, preceded(sp, <span class="built_in">char</span>(<span class="string">','</span>)), value),</span><br><span class="line">      preceded(sp, <span class="built_in">char</span>(<span class="string">']'</span>)))</span><br><span class="line">     )(i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">key_value</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, (&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, JsonValue), E&gt; &#123;</span><br><span class="line">  separated_pair!(i, preceded!(sp, string), preceded!(sp, char!(<span class="string">':'</span>)), value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>preceded</code> is a tool to check if defined something is following.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">named!(parser&lt;&amp;<span class="built_in">str</span>, &amp;<span class="built_in">str</span>&gt;, preceded!(char!(<span class="string">'-'</span>), alpha1));</span><br><span class="line"></span><br><span class="line"><span class="built_in">assert_eq!</span>(parser(<span class="string">"-abc"</span>), <span class="literal">Ok</span>((<span class="string">""</span>, <span class="string">"abc"</span>)));</span><br><span class="line"><span class="built_in">assert_eq!</span>(parser(<span class="string">"abc"</span>), <span class="literal">Err</span>(Err::Error((<span class="string">"abc"</span>, ErrorKind::Char))));</span><br><span class="line"><span class="built_in">assert_eq!</span>(parser(<span class="string">"-123"</span>), <span class="literal">Err</span>(Err::Error((<span class="string">"123"</span>, ErrorKind::Alpha))));</span><br></pre></td></tr></table></figure>
<p><code>separated_list</code> is a string <code>split</code> in native Rust (or other languages).</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">hash</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, HashMap&lt;<span class="built_in">String</span>, JsonValue&gt;, E&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> (i, _) = <span class="built_in">char</span>(<span class="string">'&#123;'</span>)(i)?;</span><br><span class="line">  context(</span><br><span class="line">    <span class="string">"map"</span>,</span><br><span class="line">    terminated(</span><br><span class="line">      |i| map!(i,</span><br><span class="line">        separated_list!(preceded!(sp, char!(<span class="string">','</span>)), key_value),</span><br><span class="line">        |tuple_vec| tuple_vec</span><br><span class="line">          .into_iter()</span><br><span class="line">          .map(|(k, v)| (<span class="built_in">String</span>::from(k), v))</span><br><span class="line">          .collect()</span><br><span class="line">      ),</span><br><span class="line">      preceded(sp, <span class="built_in">char</span>(<span class="string">'&#125;'</span>)))</span><br><span class="line">     )(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>terminated()!</code> returns the result of its first parser if both succeed</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">named!(parser&lt;&amp;<span class="built_in">str</span>, &amp;<span class="built_in">str</span>&gt;, terminated!(alpha1, char!(<span class="string">';'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="built_in">assert_eq!</span>(parser(<span class="string">"abc;"</span>), <span class="literal">Ok</span>((<span class="string">""</span>, <span class="string">"abc"</span>)));</span><br><span class="line"><span class="built_in">assert_eq!</span>(parser(<span class="string">"abc,"</span>), <span class="literal">Err</span>(Err::Error((<span class="string">","</span>, ErrorKind::Char))));</span><br><span class="line"><span class="built_in">assert_eq!</span>(parser(<span class="string">"123;"</span>), <span class="literal">Err</span>(Err::Error((<span class="string">"123;"</span>, ErrorKind::Alpha))));</span><br></pre></td></tr></table></figure>
<p>and it also takes the third parameter which is a callback like the second parameter in nom 4.3.<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">map!(i,</span><br><span class="line">    separated_list!(preceded!(sp, char!(<span class="string">','</span>)), key_value),</span><br><span class="line">    |tuple_vec| tuple_vec</span><br><span class="line">        .into_iter()</span><br><span class="line">        .map(|(k, v)| (<span class="built_in">String</span>::from(k), v))</span><br><span class="line">        .collect()</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>At the end:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">value</span></span>&lt;<span class="symbol">'a</span>, E: ParseError&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>&gt;&gt;(i: &amp;<span class="symbol">'a</span> <span class="built_in">str</span>) -&gt;IResult&lt;&amp;<span class="symbol">'a</span> <span class="built_in">str</span>, JsonValue, E&gt; &#123;</span><br><span class="line">  preceded!(i,</span><br><span class="line">    sp,</span><br><span class="line">    alt!(</span><br><span class="line">      hash    =&gt; &#123; |h| JsonValue::Object(h)            &#125; |</span><br><span class="line">      array   =&gt; &#123; |v| JsonValue::Array(v)             &#125; |</span><br><span class="line">      string  =&gt; &#123; |s| JsonValue::Str(<span class="built_in">String</span>::from(s)) &#125; |</span><br><span class="line">      float   =&gt; &#123; |f| JsonValue::Num(f)               &#125; |</span><br><span class="line">      boolean =&gt; &#123; |b| JsonValue::Boolean(b)           &#125;</span><br><span class="line">    ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>alt</code> try a list of parsers and return the result of the first successful one.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.abby.md/2019/05/16/multicasting-in-rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Abby Chau">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="abby::blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/16/multicasting-in-rust/" itemprop="url">Multicasting in Rust</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-16T15:04:24+09:00">2019-05-16</time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Networking/" itemprop="url" rel="index">
                    <span itemprop="name">Networking</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="What-is-multicasting"><a href="#What-is-multicasting" class="headerlink" title="What is multicasting?"></a>What is multicasting?</h2><p>Multicast is in parallel with concepts <code>unicast</code>, <code>broadcast</code> and <code>anycast</code>.</p>
<ul>
<li><code>unicast</code>: single source to single target (TCP or UDP)</li>
<li><code>broadcast</code>: many sources to many targets on a <strong>single network</strong> (UDP)</li>
<li><code>anycast</code>: single source to <strong>one of many targets</strong> (TCP and UDP)</li>
<li><code>multicast</code>: many source to many target (UDP and RTP)</li>
</ul>
<p>There are many setting details for the first three group communications but now we focus on the last one.</p>
<h2 id="Features-of-multicast"><a href="#Features-of-multicast" class="headerlink" title="Features of multicast"></a>Features of <code>multicast</code></h2><ul>
<li>Multicasting gives the ability for many sources to deliver packets to many destinations. </li>
<li>Similar to broadcasting, but <code>multicast</code> allows for these distributed packets to be delivered to more nodes than just the ones attached to the hosts network. </li>
<li>Multicast attempts to reduce congestion by requiring services that wish to receive multicast packets to “join” a multicast address for interest.</li>
<li><code>joins</code> are then announced to upstream routers, where different network address spaces define the scope or range up the network stack that these memberships should be announced (see rfc5771 and rfc7346 for IPv4 and IPv6 registrations). </li>
<li>This is to help prevent floods of multicast traffic hitting the Internet.</li>
</ul>
<h2 id="When-should-you-use-multicasting"><a href="#When-should-you-use-multicasting" class="headerlink" title="When should you use multicasting?"></a>When should you use multicasting?</h2><p>Whenever you need to deliver the same data to many destinations. Multicast addresses usually look like an obvious range like <code>224.0.0.251</code> (v4) or <code>FACE::FB</code> (v6) .</p>
<h2 id="Multicasting-in-Rust"><a href="#Multicasting-in-Rust" class="headerlink" title="Multicasting in Rust"></a>Multicasting in Rust</h2><ul>
<li>There is a sender and a receiver (like UDP), but the desitination IP address being sent to is a <a href="https://en.wikipedia.org/wiki/Multicast_address" target="_blank" rel="noopener">multicast address</a>.</li>
</ul>
<table>
<thead>
<tr>
<th>D类地址</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>224.0.0.1</td>
<td>在一个子网上的所有主机</td>
</tr>
<tr>
<td>224.0.0.2</td>
<td>在一个子网上的所有路由器</td>
</tr>
<tr>
<td>224.0.0.4</td>
<td>所有DVMRP协议的路由器</td>
</tr>
<tr>
<td>224.0.0.5</td>
<td>所有开放最短路径优先（OSPF）路由器</td>
</tr>
<tr>
<td>224.0.0.6</td>
<td>所有OSPF指定路由器</td>
</tr>
<tr>
<td>224.0.0.9</td>
<td>所有RIPv2路由器</td>
</tr>
<tr>
<td>224.0.0.13</td>
<td>所有PIM协议路由器</td>
</tr>
<tr>
<td>224.0.0.0-224.0.0.255</td>
<td>保留作本地使用，做管理和维护任务</td>
</tr>
<tr>
<td>239.0.0.0-239.255.255.255</td>
<td>留用做管理使用</td>
</tr>
</tbody>
</table>
<h2 id="Coding-Example"><a href="#Coding-Example" class="headerlink" title="Coding Example"></a>Coding Example</h2><p>This example is using the <code>std::net::UdpSocket</code></p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> std::net::Ipv4Addr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> socket = UdpSocket::bind(<span class="string">"0.0.0.0:8888"</span>).unwrap();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> buf = [<span class="number">0u8</span>; <span class="number">65535</span>];</span><br><span class="line">    <span class="keyword">let</span> multi_addr = Ipv4Addr::new(<span class="number">234</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">let</span> inter = Ipv4Addr::new(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    socket.join_multicast_v4(&amp;multi_addr,&amp;inter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (amt, src) = socket.recv_from(&amp;<span class="keyword">mut</span> buf).unwrap();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"received &#123;&#125; bytes from &#123;:?&#125;"</span>, amt, src);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::net::UdpSocket;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> socket = UdpSocket::bind(<span class="string">"0.0.0.0:9999"</span>).unwrap();</span><br><span class="line">    <span class="keyword">let</span> buf = [<span class="number">1u8</span>; <span class="number">15000</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> count = <span class="number">1473</span>;</span><br><span class="line">    socket.send_to(&amp;buf[<span class="number">0</span>..count], <span class="string">"234.2.2.2:8888"</span>).unwrap();</span><br><span class="line"></span><br><span class="line">    thread::sleep_ms(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h2><p><code>std::net::UdpSocket</code> is actually not providing all options from <code>libc</code>. <code>socket2</code> provide them.</p>
<p>Let’s have a look on <a href="https://github.com/bluejekyll/multicast-example/blob/master/src/lib.rs" target="_blank" rel="noopener">this example</a>.</p>
<p>We will use these : <code>use socket2::{Domain, Protocol, SockAddr, Socket, Type};</code>.</p>
<h4 id="Step-1-Bind"><a href="#Step-1-Bind" class="headerlink" title="Step 1: Bind"></a>Step 1: Bind</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(unix)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">bind_multicast</span></span>(socket: &amp;Socket, addr: &amp;SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    socket.bind(&amp;socket2::SockAddr::from(*addr))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The binding method is different from Windows and *nix, that, in Windows, </p>
<p><a href="https://docs.microsoft.com/zh-tw/windows/desktop/api/winsock/nf-winsock-bind" target="_blank" rel="noopener">https://docs.microsoft.com/zh-tw/windows/desktop/api/winsock/nf-winsock-bind</a> mentions:</p>
<blockquote>
<p>For multicast operations, the preferred method is to call the bind function to associate a socket with a local IP address and then join the multicast group. Although this order of operations is not mandatory, it is strongly recommended. So a multicast application would first select an IPv4 or IPv6 address on the local computer, the wildcard IPv4 address (INADDR_ANY), or the wildcard IPv6 address (in6addr_any). The the multicast application would then call the bind function with this address in the in the sa_data member of the name parameter to associate the local IP address with the socket. If a wildcard address was specified, then Windows will select the local IP address to use. After the bind function completes, an application would then join the multicast group of interest. For more information on how to join a multicast group, see the section on Multicast Programming. This socket can then be used to receive multicast packets from the multicast group using the recv, recvfrom, WSARecv, WSARecvEx, WSARecvFrom, or WSARecvMsg functions.</p>
</blockquote>
<p>In short, we need a <code>INADDR_ANY</code>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(windows)]</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">bind_multicast</span></span>(socket: &amp;Socket, addr: &amp;SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> addr = <span class="keyword">match</span> *addr &#123;</span><br><span class="line">        SocketAddr::V4(addr) =&gt; SocketAddr::new(Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(), addr.port()),</span><br><span class="line">        SocketAddr::V6(addr) =&gt; &#123;</span><br><span class="line">            SocketAddr::new(Ipv6Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(), addr.port())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    socket.bind(&amp;socket2::SockAddr::from(addr))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-2-Join"><a href="#Step-2-Join" class="headerlink" title="Step 2: Join"></a>Step 2: Join</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">join_multicast</span></span>(addr: SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;UdpSocket&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> ip_addr = addr.ip();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> socket = new_socket(&amp;addr)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// depending on the IP protocol we have slightly different work</span></span><br><span class="line">    <span class="keyword">match</span> ip_addr &#123;</span><br><span class="line">        IpAddr::V4(<span class="keyword">ref</span> mdns_v4) =&gt; &#123;</span><br><span class="line">            <span class="comment">// join to the multicast address, with all interfaces</span></span><br><span class="line">            socket.join_multicast_v4(mdns_v4, &amp;Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))?;</span><br><span class="line">        &#125;</span><br><span class="line">        IpAddr::V6(<span class="keyword">ref</span> mdns_v6) =&gt; &#123;</span><br><span class="line">            <span class="comment">// join to the multicast address, with all interfaces (ipv6 uses indexes not addresses)</span></span><br><span class="line">            socket.join_multicast_v6(mdns_v6, <span class="number">0</span>)?;</span><br><span class="line">            socket.set_only_v6(<span class="literal">true</span>)?;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bind us to the socket address.</span></span><br><span class="line">    bind_multicast(&amp;socket, &amp;addr)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to standard sockets</span></span><br><span class="line">    <span class="literal">Ok</span>(socket.into_udp_socket())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-3-Listener-and-Sender"><a href="#Step-3-Listener-and-Sender" class="headerlink" title="Step 3: Listener and Sender"></a>Step 3: Listener and Sender</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">multicast_listener</span></span>(</span><br><span class="line">    response: &amp;<span class="symbol">'static</span> <span class="built_in">str</span>,</span><br><span class="line">    client_done: Arc&lt;AtomicBool&gt;,</span><br><span class="line">    addr: SocketAddr,</span><br><span class="line">) -&gt; JoinHandle&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// A barrier to not start the client test code until after the server is running</span></span><br><span class="line">    <span class="keyword">let</span> server_barrier = Arc::new(Barrier::new(<span class="number">2</span>));</span><br><span class="line">    <span class="keyword">let</span> client_barrier = Arc::clone(&amp;server_barrier);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> join_handle = std::thread::Builder::new()</span><br><span class="line">        .name(<span class="built_in">format!</span>(<span class="string">"&#123;&#125;:server"</span>, response))</span><br><span class="line">        .spawn(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="comment">// socket creation will go here...</span></span><br><span class="line">            <span class="keyword">let</span> listener = join_multicast(addr).expect(<span class="string">"failed to create listener"</span>);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: joined: &#123;&#125;"</span>, response, addr);</span><br><span class="line"></span><br><span class="line">            server_barrier.wait();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: is ready"</span>, response);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We'll be looping until the client indicates it is done.</span></span><br><span class="line">            <span class="keyword">while</span> !client_done.load(std::sync::atomic::Ordering::Relaxed) &#123;</span><br><span class="line">                <span class="comment">// test receive and response code will go here...</span></span><br><span class="line">                <span class="keyword">let</span> <span class="keyword">mut</span> buf = [<span class="number">0u8</span>; <span class="number">64</span>]; <span class="comment">// receive buffer</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// we're assuming failures were timeouts, the client_done loop will stop us</span></span><br><span class="line">                <span class="keyword">match</span> listener.recv_from(&amp;<span class="keyword">mut</span> buf) &#123;</span><br><span class="line">                    <span class="literal">Ok</span>((len, remote_addr)) =&gt; &#123;</span><br><span class="line">                        <span class="keyword">let</span> data = &amp;buf[..len];</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">println!</span>(</span><br><span class="line">                            <span class="string">"&#123;&#125;:server: got data: &#123;&#125; from: &#123;&#125;"</span>,</span><br><span class="line">                            response,</span><br><span class="line">                            <span class="built_in">String</span>::from_utf8_lossy(data),</span><br><span class="line">                            remote_addr</span><br><span class="line">                        );</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// create a socket to send the response</span></span><br><span class="line">                        <span class="keyword">let</span> responder = new_socket(&amp;remote_addr)</span><br><span class="line">                            .expect(<span class="string">"failed to create responder"</span>)</span><br><span class="line">                            .into_udp_socket();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// we send the response that was set at the method beginning</span></span><br><span class="line">                        responder</span><br><span class="line">                            .send_to(response.as_bytes(), &amp;remote_addr)</span><br><span class="line">                            .expect(<span class="string">"failed to respond"</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: sent response to: &#123;&#125;"</span>, response, remote_addr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="literal">Err</span>(err) =&gt; &#123;</span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: got an error: &#123;&#125;"</span>, response, err);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:server: client is done"</span>, response);</span><br><span class="line">        &#125;)</span><br><span class="line">        .unwrap();</span><br><span class="line"></span><br><span class="line">    client_barrier.wait();</span><br><span class="line">    join_handle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">new_sender</span></span>(addr: &amp;SocketAddr) -&gt; io::<span class="built_in">Result</span>&lt;UdpSocket&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> socket = new_socket(addr)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> addr.is_ipv4() &#123;</span><br><span class="line">        socket.set_multicast_if_v4(&amp;Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))?;</span><br><span class="line"></span><br><span class="line">        socket.bind(&amp;SockAddr::from(SocketAddr::new(</span><br><span class="line">            Ipv4Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">        )))?;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *WARNING* THIS IS SPECIFIC TO THE AUTHORS COMPUTER</span></span><br><span class="line">        <span class="comment">//   find the index of your IPv6 interface you'd like to test with.</span></span><br><span class="line">        socket.set_multicast_if_v6(<span class="number">5</span>)?;</span><br><span class="line"></span><br><span class="line">        socket.bind(&amp;SockAddr::from(SocketAddr::new(</span><br><span class="line">            Ipv6Addr::new(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).into(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">        )))?;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to standard sockets...</span></span><br><span class="line">    <span class="literal">Ok</span>(socket.into_udp_socket())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Step-4-Using-Listener-and-Sender"><a href="#Step-4-Using-Listener-and-Sender" class="headerlink" title="Step 4: Using Listener and Sender"></a>Step 4: Using Listener and Sender</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">test_multicast</span></span>(test: &amp;<span class="symbol">'static</span> <span class="built_in">str</span>, addr: IpAddr) &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(addr.is_multicast());</span><br><span class="line">    <span class="keyword">let</span> addr = SocketAddr::new(addr, PORT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> client_done = Arc::new(AtomicBool::new(<span class="literal">false</span>));</span><br><span class="line">    <span class="keyword">let</span> notify = NotifyServer(Arc::clone(&amp;client_done));</span><br><span class="line"></span><br><span class="line">    multicast_listener(test, client_done, addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client test code send and receive code after here</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:client: running"</span>, test);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> message = <span class="string">b"Hello from client!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the sending socket</span></span><br><span class="line">    <span class="keyword">let</span> socket = new_sender(&amp;addr).expect(<span class="string">"could not create sender!"</span>);</span><br><span class="line">    socket.send_to(message, &amp;addr).expect(<span class="string">"could not send_to!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> buf = [<span class="number">0u8</span>; <span class="number">64</span>]; <span class="comment">// receive buffer</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> socket.recv_from(&amp;<span class="keyword">mut</span> buf) &#123;</span><br><span class="line">        <span class="literal">Ok</span>((len, remote_addr)) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> data = &amp;buf[..len];</span><br><span class="line">            <span class="keyword">let</span> response = <span class="built_in">String</span>::from_utf8_lossy(data);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:client: got data: &#123;&#125;"</span>, test, response);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// verify it's what we expected</span></span><br><span class="line">            <span class="built_in">assert_eq!</span>(test, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Err</span>(err) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">"&#123;&#125;:client: had a problem: &#123;&#125;"</span>, test, err);</span><br><span class="line">            <span class="built_in">assert!</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure we don't notify the server until the end of the client test</span></span><br><span class="line">    <span class="built_in">drop</span>(notify);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Comparing to C++ clients and servers. std libraries in Rust is much simpler, but to write codes with greater control, Rust is quite verbose but still very readable in comparison.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://www.gravatar.com/avatar/17623b699060c78823d7d6c95d1de7ec" alt="Abby Chau">
            
              <p class="site-author-name" itemprop="name">Abby Chau</p>
              <p class="site-description motion-element" itemprop="description">Sharing different computer parts</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/abbychau" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:i@abby.md" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://soundcloud.com/abbychau" target="_blank" title="SoundCloud">
                      
                        <i class="fa fa-fw fa-soundcloud"></i>SoundCloud</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/abbychau" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/zkizabby" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/abbychau" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/abbychau2000" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/abbychau" target="_blank" title="ZhiHu">
                      
                        <i class="fa fa-fw fa-question"></i>ZhiHu</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Abby Chau</span>

  

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.0.0</div>



<br>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">This site is visited <span id="busuanzi_value_site_pv"></span>times.</span>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.0"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
